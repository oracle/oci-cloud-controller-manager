box: iad.ocir.io/spinnaker/oci-kube-ci:1.0.3
no-response-timeout: 30
command-timeout: 30

#============================================
# New cloud-provider-oci build pipeline
#============================================

unit-test:
  base-path: "/go/src/github.com/oracle/oci-cloud-controller-manager"
  steps:
    - script:
      name: check boilerplate
      code: ./hack/verify-boilerplate.sh

    - script:
      name: go fmt
      code: make gofmt

    - script:
      name: golint
      code: |
        make golint

    - script:
      name: go vet
      code: make govet

    - script:
      name: unit tests
      code: make test

build-binaries:
  base-path: "/go/src/github.com/oracle/oci-cloud-controller-manager"
  steps:
    - script:
      name: build
      code: make build

    - script:
      name: manifests
      code: make manifests

    - script:
      name: write VERSION.txt
      code: |
        make version > dist/VERSION.txt
        cat dist/VERSION.txt

publish-docker-image:
  box: alpine
  docker: true
  steps:
    - script:
        name: Install docker
        code: apk --no-cache add docker

    - script:
        name: Docker login
        code: echo "Docker login"

    - script:
        name: Build cloud-provider-oci Dockerfile
        code: docker build -t iad.ocir.io/oracle/oci-cloud-provider:latest .

    - script:
        name: Push image
        code: echo "Pushing Docker image to iad.ocir.io/oracle/oci-cloud-provider:latest"

ccm-e2e-test:
  base-path: "/go/src/github.com/oracle/oci-cloud-controller-manager"
  steps:
    - script:
      name: Run CCM E2E tests
      code: |
        echo "Running CCM E2E tests"

volume-provisioner-e2e-test:
  base-path: "/go/src/github.com/oracle/oci-cloud-controller-manager"
  steps:
    - script:
      name: Run volume provisioner E2E tests
      code: |
        echo "Running volume provisioner E2E tests"

#============================================
# New cloud-provider-oci release pipeline
#============================================

# =============================
# Old pipeline
# =============================

build:
  base-path: "/go/src/github.com/oracle/oci-cloud-controller-manager"
  steps:
    - script:
      name: build
      code: make build

    - script:
      name: manifests
      code: make manifests

    - script:
      name: write VERSION.txt
      code: |
        make version > dist/VERSION.txt
        cat dist/VERSION.txt

copy:
  steps:
    - script:
      name: copy output
      code: |
        cp -a dist/* ${WERCKER_OUTPUT_DIR}

    - script:
      name: copy e2e test artifacts
      code: |
        cp -R .git ${WERCKER_OUTPUT_DIR}/
        cp Makefile ${WERCKER_OUTPUT_DIR}/
        cp -R cmd ${WERCKER_OUTPUT_DIR}/
        cp -R dist ${WERCKER_OUTPUT_DIR}/
        cp -R hack ${WERCKER_OUTPUT_DIR}/
        cp -R pkg ${WERCKER_OUTPUT_DIR}/
        cp -R test ${WERCKER_OUTPUT_DIR}/
        cp -R vendor ${WERCKER_OUTPUT_DIR}/

push:
  box:
    id: oraclelinux:7-slim
  steps:
    - script:
        name: set ENV vars
        code: |
          export VERSION=$(cat VERSION.txt)
          echo "${VERSION}"

    - script:
        name: Ensure version is unique
        code: |
          if curl -s https://api.github.com/repos/oracle/oci-cloud-controller-manager/git/refs/tags | grep "tags/$VERSION"; then
            echo "Tag $VERSION already exists. Doing nothing."
            exit 1
          fi

    - script:
        name: prepare
        code: |
          mv ./oci-cloud-controller-manager /oci-cloud-controller-manager
          chmod +x /oci-cloud-controller-manager

    - internal/docker-push:
        repository: iad.ocir.io/oracle/oci-cloud-controller-manager
        tag: $VERSION
        entrypoint: /oci-cloud-controller-manager
        user: 65534 # nobody
        registry: https://iad.ocir.io/v2
        username: $OCIRUSERNAME
        password: $OCIRPASSWORD

    - internal/docker-push:
        repository: lhr.ocir.io/oracle/oci-cloud-controller-manager
        tag: $VERSION
        entrypoint: /oci-cloud-controller-manager
        user: 65534 # nobody
        registry: https://lhr.ocir.io/v2
        username: $OCIRUSERNAME
        password: $OCIRPASSWORD

    - internal/docker-push:
        repository: phx.ocir.io/oracle/oci-cloud-controller-manager
        tag: $VERSION
        entrypoint: /oci-cloud-controller-manager
        user: 65534 # nobody
        registry: https://phx.ocir.io/v2
        username: $OCIRUSERNAME
        password: $OCIRPASSWORD

    - internal/docker-push:
        repository: fra.ocir.io/oracle/oci-cloud-controller-manager
        tag: $VERSION
        entrypoint: /oci-cloud-controller-manager
        user: 65534 # nobody
        registry: https://fra.ocir.io/v2
        username: $OCIRUSERNAME
        password: $OCIRPASSWORD

e2e-test:
  base-path: "/go/src/github.com/oracle/oci-cloud-controller-manager"
  box:
    id: iad.ocir.io/spinnaker/oci-kube-ci:1.0.3
    registry: https://iad.ocir.io/v2
  steps:
    - script:
      name: set ENV vars
      code: |
        export VERSION=$(cat VERSION.txt)
        echo "${VERSION}"
        export NODEPORT_TEST="true"
        export CCM_SECLIST_ID="ocid1.securitylist.oc1.iad.aaaaaaaagekgnvc75yxb66xj2qgocejhyk5xuhojm6wimmteqa5fj43kk5lq"
        export K8S_SECLIST_ID="ocid1.securitylist.oc1.iad.aaaaaaaajzgrgfma2xzzdv4erczaiphuyaflazbt2bvzw2cwj2pxo3fygo5a"

    - script:
      name: deploy latest CCM
      code: make upgrade

    - script:
      name: e2e default tests
      code: make e2e

  after-steps:
    - script:
      name: rollback original CCM
      code: make rollback

release:
  box:
    id: oraclelinux:7-slim
  steps:

    - script:
        name: set ENV vars
        code: |
          export VERSION=$(cat VERSION.txt)
          echo "${VERSION}"

    - script:
        name: Ensure version is unique
        code: |
          if curl -s https://api.github.com/repos/oracle/oci-cloud-controller-manager/git/refs/tags | grep "tags/$VERSION"; then
            echo "Tag $VERSION already exists. Doing nothing."
            exit 1
          fi

    - github-create-release:
      token: $GITHUB_TOKEN
      tag: $VERSION
      title: $VERSION
      draft: false

    - github-upload-asset:
      token: $GITHUB_TOKEN
      file: ./oci-cloud-controller-manager.yaml
      filename: oci-cloud-controller-manager.yaml
      content-type: text/yaml

    - github-upload-asset:
      token: $GITHUB_TOKEN
      file: ./oci-cloud-controller-manager-rbac.yaml
      filename: oci-cloud-controller-manager-rbac.yaml
      content-type: text/yaml
